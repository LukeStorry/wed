---
import Layout from "../../layouts/Layout.astro";
import { getRowsFromCode, handleUpdateForm } from "./utils";

const { code } = Astro.params;
if (!code || typeof code !== "string") {
  return Astro.redirect("/rsvp");
}

if (Astro.request.method === "POST") {
  console.log("RSVP POST Received", code);
  const formData = await Astro.request.formData();

  await handleUpdateForm(formData);
}

const people = await getRowsFromCode(code);
if (!people?.length) {
  return new Response(
    "Sorry something has gone wrong, please send Luke a message."
  );
}
---

<Layout>
  <div class="flex h-full flex-col justify-around overflow-scroll">
    <h1 class="pr-2 text-center text-2xl font-bold">RSVP</h1>

    <!-- // PEOPLE FORM -->
    <form class="" action=`/rsvp/${code}` method="POST">
      {
        people.map(({ name, attending, diet }, i) => (
          <div class="m-2 mb-6 rounded p-2">
            <input type="hidden" name={`${i}.code`} value={code} />
            <input type="hidden" name={`${i}.name`} value={name} />

            <h2 class="text-lg font-bold">{name}</h2>
            <div class="m-2 flex gap-2">
              {/* justify-evenly */}

              {/* <!-- YES RADIO INPUT  --> */}
              <label
                class:list={[
                  "rounded p-2 has-[:checked]:bg-green-800 has-[:checked]:text-white",
                  attending == "maybe"
                    ? "bg-slate-200"
                    : "has-[:not(:checked)]:line-through",
                ]}
              >
                I'll be there!
                <input
                  class="hidden"
                  value="yes"
                  type="radio"
                  name={`${i}.attending`}
                  checked={attending == "yes"}
                />
              </label>

              {/* <!-- NO RADIO INPUT  --> */}
              <label
                class:list={[
                  "rounded p-2 has-[:checked]:bg-red-500",
                  attending == "maybe"
                    ? "bg-slate-200"
                    : "has-[:not(:checked)]:line-through",
                ]}
              >
                Can't make it
                <input
                  class="hidden"
                  value="no"
                  type="radio"
                  name={`${i}.attending`}
                  checked={attending == "no"}
                />
              </label>
            </div>

            {/* <!-- DIETARY INPUT  --> */}

            {attending == "yes" && (
              <input
                class="m-2 ml-2 rounded p-2"
                aria-label="Dietary Requirements"
                placeholder="Dietary Requirements"
                name={`${i}.diet`}
                value={diet}
                type="text"
              />
            )}
          </div>
        ))
      }
      <!-- END OF FORM  -->

      <button
        class="ml-36 hidden rounded border bg-green-900 p-2 font-bold text-white"
        type="submit"
        >Update
      </button>
    </form>

    <hr />

    <!-- DETAILS SECTION  -->

    {
      people.some((p) => p.attending == "yes") ? (
        <section>
          {/* <!-- LOCATION INFO  --> */}

          <div class="m-2 rounded p-2">
            <h2 class="text-lg font-bold">Location</h2>
            <div class="grid grid-cols-2">
              <div class="flex flex-col justify-center">
                <p>
                  OA Surf Club,
                  <br /> Atlantic Court, Widemouth Bay, Cornwall,
                  <strong>EX23 0DF</strong>
                </p>
              </div>
              <div class="">
                <iframe
                  src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d10089.620279026898!2d-4.569662926881236!3d50.786601196530285!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x486c77bce0d2d9ff%3A0x24f9b527d994a22f!2sOA%20Surf%20Club%20-%20Accommodation%2C%20Widemouth%20Bay%2C%20Bude%2C%20Cornwall!5e0!3m2!1sen!2suk!4v1726951071494!5m2!1sen!2suk"
                  class="h-[200%] w-[200%] origin-top-left scale-50 rounded-lg"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                />
              </div>
            </div>
          </div>

          {/* <!-- ACCOMODATION INFO  --> */}

          <div class="m-2 flex flex-col rounded p-2">
            <h2 class="text-lg font-bold">Accomodation</h2>
            {people.some((p) => p.accommodation == "?")
              ? "We have a hostel full of rooms, give us a text to get involved!"
              : people.some((p) => p.accommodation?.includes("."))
                ? `You're down to stay in: ${people[0]?.accommodation}`
                : "There are loads of B&Bs near Widemouth Bay, and a caravan park at the end of the road. Give us a call if you want a hand!"}
          </div>
        </section>
      ) : (
        <div class="h-96" />
      )
    }
  </div>

  <script define:vars={{ people }}>
    console.log(JSON.stringify(people, null, 2));

    // Only show the button if there are changes
    document.querySelectorAll("input").forEach((input) => {
      input.addEventListener("change", () => {
        document.querySelector("button").classList.remove("hidden");
      });
    });

    // Only show the button if there are changes
    document.querySelectorAll("input").forEach((input) => {
      input.addEventListener("blur", () => {
        document.querySelector("button").classList.remove("hidden");
      });
    });
  </script>
</Layout>
